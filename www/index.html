<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataGrid5 - Ultra-Fast WebAssembly Grid Control</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>DataGrid5</h1>
            <p class="subtitle">Ultra-Fast WebAssembly Grid Control</p>
        </header>

        <div class="controls">
            <div class="control-group">
                <label>Rows:</label>
                <input type="number" id="rows" value="1000" min="1" max="100000">
            </div>
            <div class="control-group">
                <label>Columns:</label>
                <input type="number" id="cols" value="50" min="1" max="1000">
            </div>
            <button id="recreate-btn">Recreate Grid</button>
            <button id="fill-data-btn">Fill Sample Data</button>
            <button id="test-colors-btn">Test Cell Colors</button>
            <button id="test-fonts-btn">Test Font Styles</button>
        </div>

        <div class="info-panel">
            <div class="info-item">
                <span class="label">Grid Size:</span>
                <span id="grid-size">-</span>
            </div>
            <div class="info-item">
                <span class="label">Viewport:</span>
                <span id="viewport-info">-</span>
            </div>
            <div class="info-item">
                <span class="label">Rendering:</span>
                <span id="fps">Event-driven</span>
            </div>
        </div>

        <div class="search-panel">
            <div class="search-row">
                <input type="text" id="search-input" placeholder="Search in grid..." />
                <button id="search-btn">Search</button>
                <button id="search-prev-btn">◀ Prev</button>
                <button id="search-next-btn">Next ▶</button>
                <button id="search-clear-btn">Clear</button>
                <span id="search-results">-</span>
            </div>
            <div class="search-row">
                <input type="text" id="replace-input" placeholder="Replace with..." />
                <button id="replace-btn">Replace</button>
                <button id="replace-all-btn">Replace All</button>
                <label>
                    <input type="checkbox" id="case-sensitive" />
                    Case sensitive
                </label>
                <label>
                    <input type="checkbox" id="whole-word" />
                    Whole word
                </label>
            </div>
        </div>

        <div class="canvas-container">
            <div id="canvas-container"></div>
        </div>

        <div class="instructions">
            <h3>使い方 / Instructions</h3>
            <ul>
                <li><strong>マウスドラッグ / Mouse Drag:</strong> グリッドをパン / Pan the grid</li>
                <li><strong>マウスホイール / Mouse Wheel:</strong> スクロール / Scroll</li>
                <li><strong>セルクリック / Click Cell:</strong> セル選択（コンソールに表示） / Select cell (shown in console)</li>
                <li><strong>矢印キー / Arrow Keys:</strong> セル間を移動 / Navigate between cells</li>
                <li><strong>Page Up/Down:</strong> ページスクロール / Scroll by page</li>
                <li><strong>Home/End:</strong> 行の最初/最後のセルへ移動 / Jump to first/last cell in row</li>
                <li><strong>ダブルクリック / Double Click:</strong> セルを編集 / Edit cell</li>
                <li><strong>Enter:</strong> 編集を確定 / Confirm edit</li>
                <li><strong>Escape:</strong> 編集をキャンセル / Cancel edit</li>
                <li><strong>列/行の境界をドラッグ / Drag Column/Row Border:</strong> サイズ変更 / Resize</li>
                <li><strong>Shift+クリック / Shift+Click:</strong> 範囲選択 / Range selection</li>
                <li><strong>Ctrl/Cmd+クリック / Ctrl/Cmd+Click:</strong> 複数選択 / Multi selection</li>
                <li><strong>Ctrl/Cmd+C:</strong> 選択したセルをコピー / Copy selected cells</li>
                <li><strong>Ctrl/Cmd+X:</strong> 選択したセルを切り取り / Cut selected cells</li>
                <li><strong>Ctrl/Cmd+V:</strong> セルに貼り付け / Paste to cells</li>
                <li><strong>Ctrl/Cmd+A:</strong> 全選択 / Select all cells</li>
                <li><strong>行ヘッダークリック / Row Header Click:</strong> 行全体を選択 / Select entire row</li>
                <li><strong>列ヘッダークリック / Column Header Click:</strong> 列全体を選択 / Select entire column</li>
                <li><strong>左上角クリック / Top-Left Corner Click:</strong> 全選択 / Select all</li>
            </ul>
        </div>

        <footer>
            <p>
                <strong>技術スタック / Tech Stack:</strong>
                Rust + WebAssembly + WebGL |
                <a href="https://github.com/oga5/datagrid5" target="_blank">GitHub</a>
            </p>
            <p class="license">BSD 2-Clause License</p>
        </footer>
    </div>

    <script type="module">
        import init, { DataGrid } from '../pkg/datagrid5.js';
        import { DataGridWrapper } from './datagrid5-wrapper.js';

        let gridWrapper = null;

        async function initGrid() {
            await init();

            const rows = parseInt(document.getElementById('rows').value);
            const cols = parseInt(document.getElementById('cols').value);

            try {
                // Check if container exists
                const container = document.getElementById('canvas-container');
                console.log('Container found:', container);
                console.log('Container dimensions:', container.offsetWidth, 'x', container.offsetHeight);

                // Create grid using DataGridWrapper (handles all events automatically)
                gridWrapper = new DataGridWrapper('canvas-container', { DataGrid }, {
                    rows: rows,
                    cols: cols,
                    enableEditing: true,
                    enableVirtualScroll: true,
                    enableResize: true
                });

                console.log('GridWrapper created');

                // Check DOM after wrapper initialization
                setTimeout(() => {
                    const scrollContainer = document.getElementById('scroll-container');
                    const webglCanvas = document.getElementById('webgl-canvas');
                    const textCanvas = document.getElementById('text-canvas');
                    console.log('scroll-container:', scrollContainer);
                    console.log('webgl-canvas:', webglCanvas, webglCanvas?.width, 'x', webglCanvas?.height);
                    console.log('text-canvas:', textCanvas, textCanvas?.width, 'x', textCanvas?.height);
                }, 100);

                // Fill initial sample data
                fillSampleData();

                // Update info periodically
                updateInfo();
                setInterval(updateInfo, 500);

                console.log('DataGrid initialized successfully');
            } catch (error) {
                console.error('Failed to initialize DataGrid:', error);
                alert('Failed to initialize DataGrid: ' + error);
            }
        }

        function fillSampleData() {
            if (!gridWrapper) return;
            const grid = gridWrapper.getGrid();

            // Define column headers
            const columnHeaders = [
                "ID", "Name", "Email", "Age", "Department",
                "City", "Country", "Salary", "Start Date", "Status",
                "Phone", "Manager", "Team", "Projects", "Rating"
            ];

            // Set column headers (not as data, but as column names)
            for (let col = 0; col < Math.min(columnHeaders.length, 50); col++) {
                grid.set_column_name(col, columnHeaders[col] || `Column ${col + 1}`);
            }

            // Fill sample data (starting from row 0)
            const sampleNames = ["Alice Johnson", "Bob Smith", "Charlie Brown", "Diana Prince", "Emma Wilson"];
            const departments = ["Engineering", "Sales", "Marketing", "HR", "Finance"];
            const cities = ["Tokyo", "New York", "London", "Paris", "Sydney"];
            const countries = ["Japan", "USA", "UK", "France", "Australia"];
            const statuses = ["Active", "On Leave", "Remote", "In Office"];

            for (let row = 0; row < 100; row++) {
                const nameIdx = row % sampleNames.length;

                grid.set_cell_value(row, 0, String(1001 + row)); // ID
                grid.set_cell_value(row, 1, sampleNames[nameIdx]); // Name
                grid.set_cell_value(row, 2, `${sampleNames[nameIdx].toLowerCase().replace(' ', '.')}@company.com`); // Email
                grid.set_cell_value(row, 3, String(25 + (row % 30))); // Age
                grid.set_cell_value(row, 4, departments[row % departments.length]); // Department
                grid.set_cell_value(row, 5, cities[row % cities.length]); // City
                grid.set_cell_value(row, 6, countries[row % countries.length]); // Country
                grid.set_cell_value(row, 7, `$${51000 + row * 1000}`); // Salary
                grid.set_cell_value(row, 8, `2020-0${1 + (row % 9)}-15`); // Start Date
                grid.set_cell_value(row, 9, statuses[row % statuses.length]); // Status

                // Zebra striping
                if (row % 2 === 0) {
                    for (let col = 0; col < 10; col++) {
                        grid.set_cell_bg_color(row, col, 0xF5F5F5FF);
                    }
                }
            }

            gridWrapper.render();
            console.log('Filled sample data: 100 rows with proper column headers');
        }

        function updateInfo() {
            if (!gridWrapper) return;
            const grid = gridWrapper.getGrid();

            const dimensions = grid.get_dimensions();
            const selectionCount = grid.get_selection_count();

            document.getElementById('grid-size').textContent =
                `${dimensions[0]} rows × ${dimensions[1]} cols`;

            const viewportText = grid.get_viewport_info();
            const selectionText = selectionCount > 0 ? ` | Selected: ${selectionCount} cells` : '';
            document.getElementById('viewport-info').textContent =
                viewportText + selectionText;
        }

        // Button event handlers

        // Button event handlers
        function setupButtonHandlers() {
            // Recreate button
            document.getElementById('recreate-btn').addEventListener('click', () => {
                initGrid();
            });

            // Fill data button
            document.getElementById('fill-data-btn').addEventListener('click', () => {
                fillSampleData();
            });

            // Test cell colors button
            document.getElementById('test-colors-btn').addEventListener('click', () => {
                if (!gridWrapper) return;
                const grid = gridWrapper.getGrid();

                // Set background colors (RGBA as u32: 0xRRGGBBAA)
                grid.set_cell_bg_color(1, 1, 0xFF6B6BFF); // Red
                grid.set_cell_bg_color(1, 2, 0x4ECDC4FF); // Turquoise
                grid.set_cell_bg_color(1, 3, 0xFFE66DFF); // Yellow
                grid.set_cell_bg_color(1, 4, 0xA8E6CFFF); // Mint

                // Set foreground colors
                grid.set_cell_fg_color(2, 1, 0xFF0000FF); // Red text
                grid.set_cell_fg_color(2, 2, 0x0000FFFF); // Blue text
                grid.set_cell_fg_color(2, 3, 0x00FF00FF); // Green text

                gridWrapper.render();
                console.log('Applied test colors');
            });

            // Test font styles button
            document.getElementById('test-fonts-btn').addEventListener('click', () => {
                if (!gridWrapper) return;
                const grid = gridWrapper.getGrid();

                // Set font styles: bold, italic
                grid.set_cell_font_style(3, 1, true, false);  // Bold
                grid.set_cell_font_style(3, 2, false, true);  // Italic
                grid.set_cell_font_style(3, 3, true, true);   // Bold + Italic

                gridWrapper.render();
                console.log('Applied test font styles');
            });

            // Search button
            document.getElementById('search-btn').addEventListener('click', () => {
                if (!gridWrapper) return;
                const grid = gridWrapper.getGrid();
                const query = document.getElementById('search-input').value;
                const caseSensitive = document.getElementById('case-sensitive').checked;
                const wholeWord = document.getElementById('whole-word').checked;

                const count = grid.search_text_with_options(query, caseSensitive, wholeWord, false);
                updateSearchResults(count);
                gridWrapper.render();
            });

            // Search next button
            document.getElementById('search-next-btn').addEventListener('click', () => {
                if (!gridWrapper) return;
                const grid = gridWrapper.getGrid();
                grid.search_next();
                gridWrapper.render();
            });

            // Search previous button
            document.getElementById('search-prev-btn').addEventListener('click', () => {
                if (!gridWrapper) return;
                const grid = gridWrapper.getGrid();
                grid.search_prev();
                gridWrapper.render();
            });

            // Clear search button
            document.getElementById('search-clear-btn').addEventListener('click', () => {
                if (!gridWrapper) return;
                const grid = gridWrapper.getGrid();
                grid.clear_search();
                updateSearchResults(0);
                gridWrapper.render();
            });

            // Replace button
            document.getElementById('replace-btn').addEventListener('click', () => {
                if (!gridWrapper) return;
                const grid = gridWrapper.getGrid();
                const replacement = document.getElementById('replace-input').value;
                grid.replace_current(replacement);
                gridWrapper.render();
            });

            // Replace all button
            document.getElementById('replace-all-btn').addEventListener('click', () => {
                if (!gridWrapper) return;
                const grid = gridWrapper.getGrid();
                const replacement = document.getElementById('replace-input').value;
                const count = grid.replace_all(replacement);
                console.log(`Replaced ${count} occurrences`);
                gridWrapper.render();
            });

            // Search input - Enter key
            document.getElementById('search-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('search-btn').click();
                }
            });
        }

        function updateSearchResults(count) {
            const resultsElement = document.getElementById('search-results');
            if (count > 0) {
                resultsElement.textContent = `Found: ${count} result(s)`;
            } else {
                resultsElement.textContent = '-';
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            setupButtonHandlers();
            initGrid();
        });

    </script>
</body>
</html>
