<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataGrid5 - 売上分析グルーピング</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .header {
            padding: 25px;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        h1 {
            font-size: 32px;
            color: #1a202c;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .subtitle {
            color: #4a5568;
            font-size: 15px;
            margin-bottom: 10px;
        }

        .description {
            color: #718096;
            font-size: 13px;
            line-height: 1.5;
            margin-top: 8px;
        }

        .controls {
            padding: 18px 25px;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            border-top: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        button {
            padding: 10px 18px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 7px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(37, 99, 235, 0.3);
        }

        button:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #10b981;
            box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary:hover {
            background: #059669;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: #f59e0b;
            box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            background: #d97706;
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: #dc2626;
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
        }

        .info-section {
            padding: 20px 25px;
            background: rgba(255, 255, 255, 0.92);
            border-top: 1px solid #e2e8f0;
        }

        .info-row {
            display: flex;
            gap: 30px;
            margin-bottom: 15px;
        }

        .info-box {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
        }

        .info-box h3 {
            font-size: 13px;
            font-weight: 600;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-box .value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .info-box .label {
            font-size: 12px;
            opacity: 0.85;
        }

        .structure-info {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 12px;
        }

        .structure-info h4 {
            color: #2d3748;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .structure-level {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #cbd5e0;
        }

        .structure-level:last-child {
            border-bottom: none;
        }

        .level-badge {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        .level-content {
            margin-left: 15px;
            color: #4a5568;
            font-size: 13px;
        }

        .level-content strong {
            color: #2d3748;
        }

        .grid-container {
            flex: 1;
            position: relative;
            min-height: 0;
            background: white;
            margin: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        #scroll-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
            z-index: 3;
        }

        #scroll-content {
            position: relative;
            pointer-events: none;
        }

        #webgl-canvas, #text-canvas {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
            pointer-events: none;
        }

        #webgl-canvas {
            z-index: 1;
        }

        #text-canvas {
            z-index: 2;
            cursor: cell;
            pointer-events: all;
        }

        .status-bar {
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.95);
            border-top: 2px solid #e2e8f0;
            display: flex;
            gap: 30px;
            font-size: 13px;
            color: #4a5568;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .status-item {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .status-label {
            font-weight: 700;
            color: #2d3748;
        }

        .status-value {
            background: #edf2f7;
            padding: 4px 10px;
            border-radius: 5px;
            font-weight: 600;
            color: #2d3748;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #4a5568;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #cbd5e0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📊 年間売上分析ダッシュボード</h1>
        <p class="subtitle">3レベル列グルーピング: 四半期 → 月次 → メトリクス</p>
        <p class="description">
            このサンプルは、四半期（Q1-Q4）を最上位グループ、各月を第2レベル、売上・利益・件数を第3レベルとした
            3階層の列ヘッダグルーピングを実装しています。全国10店舗の月次売上データを可視化します。
        </p>
    </div>

    <div class="controls">
        <button id="load-yearly-btn" class="btn-secondary">📅 年間データ読込 (Q1-Q4)</button>
        <button id="load-h1-btn">📊 上半期のみ (Q1-Q2)</button>
        <button id="load-h2-btn">📈 下半期のみ (Q3-Q4)</button>
        <button id="highlight-btn" class="btn-warning">🎨 高収益セルを強調</button>
        <button id="clear-highlight-btn" class="btn-danger">✕ 強調解除</button>
    </div>

    <div class="info-section">
        <div class="info-row">
            <div class="info-box">
                <h3>年間売上合計</h3>
                <div class="value" id="total-sales">¥0</div>
                <div class="label">全店舗合計</div>
            </div>
            <div class="info-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h3>年間利益合計</h3>
                <div class="value" id="total-profit">¥0</div>
                <div class="label">営業利益</div>
            </div>
            <div class="info-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <h3>年間取引件数</h3>
                <div class="value" id="total-orders">0件</div>
                <div class="label">総取引数</div>
            </div>
        </div>

        <div class="structure-info">
            <h4>📋 データ構造（3レベルヘッダ）</h4>
            <div class="structure-level">
                <div class="level-badge">レベル 0</div>
                <div class="level-content">
                    <strong>四半期:</strong> Q1 (1-3月) / Q2 (4-6月) / Q3 (7-9月) / Q4 (10-12月)
                </div>
            </div>
            <div class="structure-level">
                <div class="level-badge">レベル 1</div>
                <div class="level-content">
                    <strong>月次:</strong> 各四半期配下の月（1月、2月、3月 など）
                </div>
            </div>
            <div class="structure-level">
                <div class="level-badge">レベル 2</div>
                <div class="level-content">
                    <strong>メトリクス:</strong> 売上（円）、利益（円）、件数（取引数）
                </div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #fef3c7;"></div>
                売上 ¥500万以上
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #dbeafe;"></div>
                利益 ¥100万以上
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #dcfce7;"></div>
                件数 400件以上
            </div>
        </div>
    </div>

    <div class="grid-container">
        <canvas id="webgl-canvas"></canvas>
        <canvas id="text-canvas" tabindex="0"></canvas>
        <div id="scroll-container">
            <div id="scroll-content"></div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <span class="status-label">ヘッダレベル:</span>
            <span class="status-value" id="header-levels">4</span>
        </div>
        <div class="status-item">
            <span class="status-label">ヘッダ高さ:</span>
            <span class="status-value" id="header-height">120px</span>
        </div>
        <div class="status-item">
            <span class="status-label">グループ数:</span>
            <span class="status-value" id="group-count">16</span>
        </div>
        <div class="status-item">
            <span class="status-label">データ範囲:</span>
            <span class="status-value" id="data-range">-</span>
        </div>
    </div>

    <script type="module">
        import init, { DataGrid } from '../pkg/datagrid5.js';

        let grid = null;
        let isInternalScroll = false;
        let currentData = null;

        // 店舗データ
        const stores = [
            "東京本店", "大阪支店", "名古屋支店", "福岡支店", "札幌支店",
            "仙台支店", "広島支店", "京都支店", "横浜支店", "神戸支店"
        ];

        async function initGrid() {
            await init();

            const webglCanvas = document.getElementById('webgl-canvas');
            const textCanvas = document.getElementById('text-canvas');
            const scrollContainer = document.getElementById('scroll-container');

            const containerRect = scrollContainer.getBoundingClientRect();
            const width = Math.floor(containerRect.width);
            const height = Math.floor(containerRect.height);

            // Set canvas dimensions before creating grid
            webglCanvas.width = width;
            webglCanvas.height = height;
            textCanvas.width = width;
            textCanvas.height = height;

            // Create grid: 11 rows (1 header + 10 stores) x 36 columns (12 months × 3 metrics)
            grid = new DataGrid('webgl-canvas', 'text-canvas', 11, 36);

            setupEventHandlers();
            setupVirtualScroll();

            // Start render loop
            renderLoop();

            console.log('Sales analysis grid initialized');
        }

        function renderLoop() {
            if (!grid) return;
            grid.render();
            requestAnimationFrame(renderLoop);
        }

        function setupEventHandlers() {
            const textCanvas = document.getElementById('text-canvas');

            textCanvas.addEventListener('mousedown', (e) => {
                const rect = textCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                grid.handle_mouse_down_with_modifiers(x, y, {
                    shift: e.shiftKey,
                    ctrl: e.ctrlKey || e.metaKey,
                    alt: e.altKey
                });
            });

            textCanvas.addEventListener('mousemove', (e) => {
                const rect = textCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                grid.handle_mouse_move(x, y);
            });

            textCanvas.addEventListener('mouseup', (e) => {
                const rect = textCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                grid.handle_mouse_up(x, y);
            });

            textCanvas.addEventListener('keydown', (e) => {
                const handled = grid.handle_keyboard_with_modifiers(e.key, {
                    shift: e.shiftKey,
                    ctrl: e.ctrlKey || e.metaKey,
                    alt: e.altKey
                });
                if (handled) {
                    e.preventDefault();
                    syncScrollPosition();
                }
            });

            textCanvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                grid.handle_wheel(e.deltaX, e.deltaY);
            });
        }

        function setupVirtualScroll() {
            const scrollContainer = document.getElementById('scroll-container');
            updateVirtualScrollSize();

            scrollContainer.addEventListener('scroll', () => {
                if (!grid || isInternalScroll) {
                    isInternalScroll = false;
                    return;
                }
                grid.set_scroll(scrollContainer.scrollLeft, scrollContainer.scrollTop);
            });
        }

        function updateVirtualScrollSize() {
            if (!grid) return;
            const scrollContent = document.getElementById('scroll-content');
            const totalSize = JSON.parse(grid.get_total_size());
            scrollContent.style.width = totalSize[0] + 'px';
            scrollContent.style.height = totalSize[1] + 'px';
        }

        function syncScrollPosition() {
            if (!grid) return;
            const scrollContainer = document.getElementById('scroll-container');
            const viewport = JSON.parse(grid.get_viewport_info_array());
            isInternalScroll = true;
            scrollContainer.scrollLeft = viewport[3];
            scrollContainer.scrollTop = viewport[2];
        }

        function setupColumnGroups(quarters) {
            grid.clear_column_groups();

            const quarterConfig = {
                'Q1': { months: [1, 2, 3], startCol: 0 },
                'Q2': { months: [4, 5, 6], startCol: 9 },
                'Q3': { months: [7, 8, 9], startCol: 18 },
                'Q4': { months: [10, 11, 12], startCol: 27 }
            };

            let groupCount = 0;

            quarters.forEach((q, idx) => {
                const config = quarterConfig[q];
                const endCol = config.startCol + 8; // 3 months × 3 metrics = 9 columns

                // Level 0: Quarter
                grid.add_column_group(`${q} (${config.months[0]}-${config.months[2]}月)`,
                    config.startCol, endCol, 0);
                groupCount++;

                // Level 1: Months
                config.months.forEach((month, mIdx) => {
                    const monthStart = config.startCol + (mIdx * 3);
                    const monthEnd = monthStart + 2;
                    grid.add_column_group(`${month}月`, monthStart, monthEnd, 1);
                    groupCount++;
                });
            });

            // Set header row height
            grid.set_header_row_height(30);

            // Set column headers (Level 2: Metrics)
            const metrics = ["売上", "利益", "件数"];
            for (let col = 0; col < 36; col++) {
                const metricIdx = col % 3;
                grid.update_cell_value(0, col, metrics[metricIdx]);

                // Style header
                const colors = [0x3b82f6FF, 0xef4444FF, 0x10b981FF];
                grid.set_cell_bg_color(0, col, colors[metricIdx]);
                grid.set_cell_fg_color(0, col, 0xFFFFFFFF);
                grid.set_cell_font_style(0, col, true, false);
            }

            document.getElementById('group-count').textContent = groupCount;
            updateStatusBar();
        }

        function generateSalesData(quarters) {
            const data = [];
            const quarterMonths = {
                'Q1': [1, 2, 3],
                'Q2': [4, 5, 6],
                'Q3': [7, 8, 9],
                'Q4': [10, 11, 12]
            };

            stores.forEach((store, storeIdx) => {
                const row = storeIdx + 1;
                const rowData = { store, metrics: [] };

                quarters.forEach(q => {
                    const months = quarterMonths[q];
                    months.forEach(month => {
                        // Generate realistic sales data with seasonal variations
                        const seasonalFactor = month >= 11 || month <= 2 ? 1.3 : // Peak season
                                             month >= 3 && month <= 5 ? 1.1 :   // Spring
                                             month >= 6 && month <= 8 ? 0.9 :   // Summer dip
                                             1.0;                                // Fall

                        const baseSales = 2000000 + (storeIdx * 100000); // 2M-3M base
                        const sales = Math.floor(baseSales * seasonalFactor * (0.9 + Math.random() * 0.4));
                        const profit = Math.floor(sales * (0.15 + Math.random() * 0.15)); // 15-30% margin
                        const orders = Math.floor(200 + Math.random() * 300);

                        rowData.metrics.push({ sales, profit, orders });
                    });
                });

                data.push(rowData);
            });

            return data;
        }

        function loadSalesData(quarters) {
            if (!grid) return;

            setupColumnGroups(quarters);
            const data = generateSalesData(quarters);
            currentData = data;

            // Note: Store names would be displayed in row headers
            // But DataGrid5 handles row headers automatically (row numbers)
            // Store names are in the data but not displayed in row headers

            // Fill data
            let totalSales = 0;
            let totalProfit = 0;
            let totalOrders = 0;

            data.forEach((storeData, storeIdx) => {
                const row = storeIdx + 1;
                storeData.metrics.forEach((metric, metricIdx) => {
                    const baseCol = metricIdx * 3;

                    // Sales
                    const salesText = `¥${(metric.sales / 10000).toFixed(0)}万`;
                    grid.update_cell_value(row, baseCol, salesText);
                    totalSales += metric.sales;

                    // Profit
                    const profitText = `¥${(metric.profit / 10000).toFixed(0)}万`;
                    grid.update_cell_value(row, baseCol + 1, profitText);
                    totalProfit += metric.profit;

                    // Orders
                    grid.update_cell_value(row, baseCol + 2, `${metric.orders}件`);
                    totalOrders += metric.orders;
                });
            });

            // Update summary
            document.getElementById('total-sales').textContent =
                `¥${(totalSales / 100000000).toFixed(2)}億`;
            document.getElementById('total-profit').textContent =
                `¥${(totalProfit / 100000000).toFixed(2)}億`;
            document.getElementById('total-orders').textContent =
                `${totalOrders.toLocaleString()}件`;

            const range = quarters.length === 4 ? '通年' :
                         quarters[0] === 'Q1' ? '上半期' : '下半期';
            document.getElementById('data-range').textContent = range;

            updateVirtualScrollSize();
        }

        function highlightHighPerformance() {
            if (!grid || !currentData) return;

            currentData.forEach((storeData, storeIdx) => {
                const row = storeIdx + 1;
                storeData.metrics.forEach((metric, metricIdx) => {
                    const baseCol = metricIdx * 3;

                    // Highlight high sales (≥5M)
                    if (metric.sales >= 5000000) {
                        grid.set_cell_bg_color(row, baseCol, 0xfef3c7FF);
                    }

                    // Highlight high profit (≥1M)
                    if (metric.profit >= 1000000) {
                        grid.set_cell_bg_color(row, baseCol + 1, 0xdbeafeFF);
                    }

                    // Highlight high orders (≥400)
                    if (metric.orders >= 400) {
                        grid.set_cell_bg_color(row, baseCol + 2, 0xdcfce7FF);
                    }
                });
            });
        }

        function clearHighlight() {
            if (!grid) return;

            for (let row = 1; row <= 10; row++) {
                for (let col = 0; col < 36; col++) {
                    if (col % 3 !== 0 || row > 0) { // Don't clear headers
                        grid.set_cell_bg_color(row, col, 0xFFFFFFFF);
                    }
                }
            }
        }

        function updateStatusBar() {
            if (!grid) return;
            document.getElementById('header-levels').textContent = grid.get_header_levels();
            document.getElementById('header-height').textContent =
                grid.get_header_height().toFixed(0) + 'px';
        }

        // Button handlers
        document.getElementById('load-yearly-btn').addEventListener('click', () => {
            loadSalesData(['Q1', 'Q2', 'Q3', 'Q4']);
        });

        document.getElementById('load-h1-btn').addEventListener('click', () => {
            loadSalesData(['Q1', 'Q2']);
        });

        document.getElementById('load-h2-btn').addEventListener('click', () => {
            loadSalesData(['Q3', 'Q4']);
        });

        document.getElementById('highlight-btn').addEventListener('click', () => {
            highlightHighPerformance();
        });

        document.getElementById('clear-highlight-btn').addEventListener('click', () => {
            clearHighlight();
        });

        // Resize handler
        const resizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                if (!grid) return;

                const width = Math.floor(entry.contentRect.width);
                const height = Math.floor(entry.contentRect.height);

                const webglCanvas = document.getElementById('webgl-canvas');
                const textCanvas = document.getElementById('text-canvas');

                webglCanvas.width = width;
                webglCanvas.height = height;
                textCanvas.width = width;
                textCanvas.height = height;

                grid.resize(width, height);
                updateVirtualScrollSize();
            }
        });

        resizeObserver.observe(document.getElementById('scroll-container'));

        // Initialize and load yearly data
        initGrid().then(() => {
            loadSalesData(['Q1', 'Q2', 'Q3', 'Q4']);
        });
    </script>
</body>
</html>
